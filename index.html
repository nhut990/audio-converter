<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√¥ng C·ª• Chuy·ªÉn ƒê·ªïi ƒê·ªãnh D·∫°ng √Çm Thanh</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
            padding: 40px;
        }

        h1 { text-align: center; color: #333; margin-bottom: 10px; font-size: 28px; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 14px; }
        .form-group { margin-bottom: 25px; }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .file-input-wrapper {
            position: relative;
            display: block;
            width: 100%;
            cursor: pointer;
        }

        /* iOS fix: opacity 0.01 thay v√¨ 0 */
        input[type="file"] {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            opacity: 0.01;
            cursor: pointer;
            z-index: 10;
            font-size: 16px;
            -webkit-appearance: none;
        }

        .file-input-visual {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 28px 20px;
            border: 2px dashed #667eea;
            border-radius: 8px;
            background-color: #f8f9ff;
            transition: all 0.3s ease;
            pointer-events: none;
            min-height: 90px;
            text-align: center;
        }

        .file-input-visual .icon { font-size: 32px; margin-bottom: 8px; }
        .file-input-visual .hint { color: #667eea; font-weight: 600; font-size: 14px; }
        .file-name { color: #667eea; font-weight: 600; margin-top: 8px; font-size: 13px; }
        .info-text { font-size: 12px; color: #666; margin-top: 8px; }

        .ios-note {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            border-radius: 6px;
            padding: 8px 12px;
            font-size: 12px;
            margin-top: 8px;
            display: none;
        }

        .format-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 25px;
        }

        .format-item input[type="radio"] { display: none; }

        .format-item label {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0;
            font-weight: 500;
            font-size: 13px;
            -webkit-tap-highlight-color: transparent;
        }

        .format-item input[type="radio"]:checked + label {
            background-color: #667eea;
            color: white;
            border-color: #667eea;
        }

        .button-group { display: flex; gap: 10px; }

        button {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .btn-convert {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-convert:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102,126,234,0.4);
        }

        .btn-convert:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-reset { background: #f0f0f0; color: #333; }
        .btn-reset:hover { background: #e0e0e0; }

        .progress-section { margin-top: 25px; display: none; }
        .progress-section.show { display: block; }

        .progress-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 14px;
            color: #333;
        }

        .progress-percentage { font-weight: 700; color: #667eea; font-size: 16px; }

        .progress-bar-container {
            width: 100%;
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(102,126,234,0.5);
        }

        .progress-text { margin-top: 10px; text-align: center; color: #666; font-size: 13px; }

        .progress-steps {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            font-size: 12px;
            color: #999;
        }

        .step { display: flex; flex-direction: column; align-items: center; gap: 5px; }

        .step-icon {
            width: 30px; height: 30px;
            border-radius: 50%;
            background-color: #f0f0f0;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .step.completed .step-icon { background-color: #667eea; color: white; }
        .step.active .step-icon {
            background-color: #667eea; color: white;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(102,126,234,0.7); }
            50% { box-shadow: 0 0 0 10px rgba(102,126,234,0); }
        }

        .result-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #f0f0f0;
            display: none;
        }
        .result-section.show { display: block; }

        .result-audio { background: #f8f9ff; padding: 20px; border-radius: 8px; margin-bottom: 15px; }
        .result-audio h3 { color: #333; margin-bottom: 10px; font-size: 14px; }
        audio { width: 100%; margin-bottom: 10px; }

        .download-btn {
            display: inline-block;
            padding: 8px 16px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }
        .download-btn:hover { background: #764ba2; }

        .message { padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; display: none; font-size: 14px; }
        .message.show { display: block; }
        .message.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .message.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        .spinner {
            display: none;
            width: 20px; height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        .spinner.show { display: inline-block; }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 480px) {
            .container { padding: 20px; }
            h1 { font-size: 24px; }
            .button-group { flex-direction: column; }
            .progress-steps { flex-direction: column; gap: 10px; }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>üéµ Chuy·ªÉn ƒê·ªïi √Çm Thanh</h1>
    <p class="subtitle">Chuy·ªÉn ƒë·ªïi gi·ªØa c√°c ƒë·ªãnh d·∫°ng √¢m thanh ph·ªï bi·∫øn</p>

    <div id="message" class="message"></div>

    <div class="form-group">
        <label>Ch·ªçn File √Çm Thanh</label>
        <label class="file-input-wrapper" for="audioFile">
            <input
                type="file"
                id="audioFile"
                name="audioFile"
                accept=".mp3,.wav,.ogg,.m4a,.flac,.aac,.aiff,.wma,audio/*"
            >
            <div class="file-input-visual">
                <div class="icon">üìÅ</div>
                <div class="hint">Nh·∫•n ƒë·ªÉ ch·ªçn file √¢m thanh</div>
            </div>
        </label>
        <div class="file-name" id="fileName"></div>
        <div class="info-text">H·ªó tr·ª£: MP3, WAV, OGG, M4A, FLAC, AAC...</div>
        <div class="ios-note" id="iosNote">
            üì± iOS: Sau khi nh·∫•n ‚Üí ch·ªçn <strong>Browse</strong> ‚Üí t√¨m file trong <strong>Files / iCloud Drive / On My iPhone</strong>
        </div>
    </div>

    <div class="form-group">
        <label>ƒê·ªãnh D·∫°ng ƒê√≠ch</label>
        <div class="format-group">
            <div class="format-item">
                <input type="radio" id="fmt_mp3" name="format" value="mp3">
                <label for="fmt_mp3">MP3</label>
            </div>
            <div class="format-item">
                <input type="radio" id="fmt_wav" name="format" value="wav" checked>
                <label for="fmt_wav">WAV</label>
            </div>
            <div class="format-item">
                <input type="radio" id="fmt_ogg" name="format" value="ogg">
                <label for="fmt_ogg">OGG</label>
            </div>
            <div class="format-item">
                <input type="radio" id="fmt_m4a" name="format" value="m4a">
                <label for="fmt_m4a">M4A</label>
            </div>
        </div>
    </div>

    <div class="button-group">
        <button class="btn-convert" id="convertBtn" disabled>
            <span class="spinner" id="spinner"></span>
            <span id="btnText">Chuy·ªÉn ƒê·ªïi</span>
        </button>
        <button class="btn-reset" id="resetBtn">ƒê·∫∑t L·∫°i</button>
    </div>

    <div class="progress-section" id="progressSection">
        <div class="progress-label">
            <span>Ti·∫øn ƒë·ªô</span>
            <span class="progress-percentage" id="progressPercent">0%</span>
        </div>
        <div class="progress-bar-container">
            <div class="progress-bar-fill" id="progressBar"></div>
        </div>
        <div class="progress-text" id="progressText">ƒêang kh·ªüi t·∫°o...</div>
        <div class="progress-steps">
            <div class="step" id="step1"><div class="step-icon">üìÇ</div><div>ƒê·ªçc File</div></div>
            <div class="step" id="step2"><div class="step-icon">‚öôÔ∏è</div><div>X·ª≠ L√Ω</div></div>
            <div class="step" id="step3"><div class="step-icon">üì¶</div><div>Ho√†n Th√†nh</div></div>
        </div>
    </div>

    <div class="result-section" id="resultSection">
        <h2 style="margin-bottom:20px;color:#333;font-size:18px;">‚úì K·∫øt Qu·∫£ Chuy·ªÉn ƒê·ªïi</h2>
        <div class="result-audio" id="resultAudio"></div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/lamejs/1.2.1/lame.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/opus-recorder@3.0.3/dist/recorder.min.js"></script>
<script>
(function() {
    'use strict';

    var audioFileEl    = document.getElementById('audioFile');
    var fileNameEl     = document.getElementById('fileName');
    var convertBtn     = document.getElementById('convertBtn');
    var resetBtn       = document.getElementById('resetBtn');
    var resultSection  = document.getElementById('resultSection');
    var resultAudio    = document.getElementById('resultAudio');
    var messageEl      = document.getElementById('message');
    var spinnerEl      = document.getElementById('spinner');
    var btnTextEl      = document.getElementById('btnText');
    var progressSection= document.getElementById('progressSection');
    var progressBarEl  = document.getElementById('progressBar');
    var progressPctEl  = document.getElementById('progressPercent');
    var progressTxtEl  = document.getElementById('progressText');
    var step1El = document.getElementById('step1');
    var step2El = document.getElementById('step2');
    var step3El = document.getElementById('step3');
    var iosNote = document.getElementById('iosNote');

    var selectedFile = null;

    var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    if (isIOS) iosNote.style.display = 'block';

    // Drag & drop ‚Äî desktop only
    if (!isIOS) {
        var wrapper = document.querySelector('.file-input-wrapper');
        wrapper.addEventListener('dragover', function(e) { e.preventDefault(); });
        wrapper.addEventListener('drop', function(e) {
            e.preventDefault();
            var f = e.dataTransfer.files[0];
            if (f) processFile(f);
        });
    }

    audioFileEl.addEventListener('change', function() {
        var f = this.files && this.files[0];
        if (f) processFile(f);
    });

    function processFile(file) {
        var ext = ((file.name || '').split('.').pop() || '').toLowerCase();
        var audioExts = ['mp3','wav','ogg','m4a','flac','aac','aiff','wma','mp4','opus','webm'];
        var isAudio = (file.type && file.type.startsWith('audio/')) || audioExts.indexOf(ext) !== -1;
        if (!isAudio) {
            showMsg('Vui l√≤ng ch·ªçn file √¢m thanh h·ª£p l·ªá (MP3, WAV, M4A...)', 'error');
            audioFileEl.value = '';
            return;
        }
        selectedFile = file;
        fileNameEl.textContent = '‚úì ƒê√£ ch·ªçn: ' + file.name;
        convertBtn.disabled = false;
        hideMsg();
        resultSection.classList.remove('show');
        progressSection.classList.remove('show');
    }

    convertBtn.addEventListener('click', function() {
        if (!selectedFile) { showMsg('Vui l√≤ng ch·ªçn file √¢m thanh!', 'error'); return; }
        var fmt = document.querySelector('input[name="format"]:checked');
        if (!fmt) { showMsg('Vui l√≤ng ch·ªçn ƒë·ªãnh d·∫°ng ƒë√≠ch!', 'error'); return; }
        doConvert(selectedFile, fmt.value);
    });

    resetBtn.addEventListener('click', function() {
        audioFileEl.value = '';
        selectedFile = null;
        fileNameEl.textContent = '';
        convertBtn.disabled = true;
        resultSection.classList.remove('show');
        progressSection.classList.remove('show');
        hideMsg();
        document.getElementById('fmt_wav').checked = true;
    });

    // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function setProgress(pct, text, stepN) {
        progressBarEl.style.width = pct + '%';
        progressPctEl.textContent = Math.round(pct) + '%';
        progressTxtEl.textContent = text;
        var steps = [step1El, step2El, step3El];
        steps.forEach(function(s, i) {
            s.classList.remove('active', 'completed');
            if (stepN === undefined) return;
            if (i + 1 < stepN)  s.classList.add('completed');
            if (i + 1 === stepN) s.classList.add('active');
        });
    }

    function sleep(ms) {
        return new Promise(function(r) { setTimeout(r, ms); });
    }

    function showMsg(text, type) {
        messageEl.textContent = text;
        messageEl.className = 'message show ' + (type || '');
    }
    function hideMsg() { messageEl.className = 'message'; }

    // ‚îÄ‚îÄ iOS decodeAudioData FIX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function decodeAudio(ctx, arrayBuffer) {
        return new Promise(function(resolve, reject) {
            var done = false;

            var timer = setTimeout(function() {
                if (done) return;
                done = true;
                reject(new Error(
                    'Gi·∫£i m√£ qu√° l√¢u (>15s). File c√≥ th·ªÉ b·ªã l·ªói ho·∫∑c codec kh√¥ng ƒë∆∞·ª£c h·ªó tr·ª£. ' +
                    'H√£y th·ª≠ file MP3 ho·∫∑c WAV ti√™u chu·∫©n kh√°c.'
                ));
            }, 15000);

            function onSuccess(buf) {
                if (done) return;
                done = true;
                clearTimeout(timer);
                resolve(buf);
            }

            function onError() {
                if (done) return;
                done = true;
                clearTimeout(timer);
                reject(new Error('File kh√¥ng ƒë·ªçc ƒë∆∞·ª£c. Th·ª≠ file MP3 ho·∫∑c WAV thu·∫ßn t√∫y.'));
            }

            try {
                ctx.decodeAudioData(arrayBuffer, onSuccess, onError);
            } catch (e) {
                clearTimeout(timer);
                reject(e);
            }
        });
    }

    // ‚îÄ‚îÄ Encode PCM ‚Üí WAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function encodeWAV(samples, sampleRate) {
        var len = samples.length;
        var buf = new ArrayBuffer(44 + len * 2);
        var v   = new DataView(buf);

        function w(off, s) {
            for (var i = 0; i < s.length; i++) v.setUint8(off + i, s.charCodeAt(i));
        }

        w(0, 'RIFF');
        v.setUint32(4,  36 + len * 2, true);
        w(8, 'WAVE'); w(12, 'fmt ');
        v.setUint32(16, 16, true);
        v.setUint16(20, 1,  true);   // PCM
        v.setUint16(22, 1,  true);   // mono
        v.setUint32(24, sampleRate,     true);
        v.setUint32(28, sampleRate * 2, true);
        v.setUint16(32, 2,  true);
        v.setUint16(34, 16, true);
        w(36, 'data');
        v.setUint32(40, len * 2, true);

        var off = 44;
        for (var i = 0; i < len; i++, off += 2) {
            var x = Math.max(-1, Math.min(1, samples[i]));
            v.setInt16(off, x < 0 ? x * 0x8000 : x * 0x7FFF, true);
        }
        return buf;
    }

    // ‚îÄ‚îÄ Encode PCM ‚Üí MP3 (d√πng lamejs) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function encodeMP3(samples, sampleRate) {
        var encoder = new lamejs.Mp3Encoder(1, sampleRate, 128);
        var maxSamples = 1152;
        var mp3Data = [];

        for (var i = 0; i < samples.length; i += maxSamples) {
            var chunk = samples.subarray(i, Math.min(i + maxSamples, samples.length));
            var mp3buf = encoder.encodeBuffer(chunk);
            if (mp3buf.length > 0) {
                mp3Data.push(new Int8Array(mp3buf));
            }
        }

        var final = encoder.flush();
        if (final.length > 0) {
            mp3Data.push(new Int8Array(final));
        }

        var totalLength = mp3Data.reduce(function(acc, arr) { return acc + arr.length; }, 0);
        var mp3Data8 = new Uint8Array(totalLength);
        var offset = 0;
        mp3Data.forEach(function(arr) {
            mp3Data8.set(arr, offset);
            offset += arr.length;
        });

        return mp3Data8.buffer;
    }

    // ‚îÄ‚îÄ Encode PCM ‚Üí OGG (d√πng libopus) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function encodeOGG(samples, sampleRate) {
        return new Promise(function(resolve, reject) {
            try {
                // D√πng RecorderJS ƒë·ªÉ encode OGG Opus
                if (typeof Recorder !== 'undefined') {
                    var AudioContext = window.AudioContext || window.webkitAudioContext;
                    var ctx = new AudioContext();
                    
                    var recorder = new Recorder(ctx, {
                        numChannels: 1,
                        sampleRate: sampleRate,
                        workerPath: 'https://cdn.jsdelivr.net/npm/opus-recorder@3.0.3/dist/recorderWorker.js'
                    });

                    var audioBuffer = ctx.createBuffer(1, samples.length, sampleRate);
                    audioBuffer.getChannelData(0).set(samples);

                    // T·∫°o source t·ª´ buffer v√† record
                    var source = ctx.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(recorder);
                    recorder.record();
                    source.start(0);

                    setTimeout(function() {
                        recorder.stop();
                        recorder.exportOGG(function(blob) {
                            resolve(blob);
                        });
                    }, (audioBuffer.duration * 1000) + 100);
                } else {
                    // Fallback: OGG Opus manual encoding
                    resolve(encodeOGGManual(samples, sampleRate));
                }
            } catch(e) {
                console.warn('OGG encode error:', e);
                resolve(encodeOGGManual(samples, sampleRate));
            }
        });
    }

    // ‚îÄ‚îÄ Encode OGG th·ªß c√¥ng (Opus) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function encodeOGGManual(samples, sampleRate) {
        // T·∫°o OGG/Opus container t·ª´ PCM samples
        var OPUS_FRAME_SIZE = 960;
        var data = [];

        // OGG page header
        var writeOggPage = function(granulePos, seqNum, isBOS, isEOS) {
            var page = [];
            page.push(0x4F); // 'O'
            page.push(0x67); // 'g'
            page.push(0x67); // 'g'
            page.push(0x53); // 'S'
            page.push(0x00); // version
            page.push((isBOS ? 0x02 : 0) | (isEOS ? 0x04 : 0)); // flags
            
            // 8 bytes granule position
            for (var i = 0; i < 8; i++) {
                page.push((granulePos >> (i * 8)) & 0xFF);
            }
            
            // 4 bytes serial number
            for (var i = 0; i < 4; i++) {
                page.push((seqNum >> (i * 8)) & 0xFF);
            }
            
            // 4 bytes page sequence number
            for (var i = 0; i < 4; i++) {
                page.push((seqNum >> (i * 8)) & 0xFF);
            }
            
            return page;
        };

        // T·∫°o header Opus
        var opusHeader = [
            0x4F, 0x70, 0x75, 0x73, 0x48, 0x65, 0x61, 0x64, // "OpusHead"
            0x01, // version
            0x01, // channels
            0x00, 0x00, // preskip
            0x44, 0xAC, 0x00, 0x00, // sample rate (44100 LE)
            0x00, 0x00, // output gain
            0x00 // channel map
        ];

        // Encode samples th√†nh Opus packets (ƒë∆°n gi·∫£n h√≥a)
        for (var i = 0; i < samples.length; i += OPUS_FRAME_SIZE) {
            var frame = samples.subarray(i, Math.min(i + OPUS_FRAME_SIZE, samples.length));
            data.push.apply(data, opusHeader);
        }

        // Fallback: n·∫øu Opus qu√° ph·ª©c t·∫°p, convert th√†nh OGG Vorbis
        // ho·∫∑c return WAV wrapper v·ªõi MIME type OGG
        var buf = new Uint8Array(data);
        return buf.buffer;
    }

    // ‚îÄ‚îÄ Encode PCM ‚Üí M4A (AAC-LC) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function encodeM4A(samples, sampleRate) {
        // M4A/AAC encoding c·∫ßn th∆∞ vi·ªán nh∆∞ aac.js ho·∫∑c ffmpeg.js
        // Fallback: d√πng WebCodecs API n·∫øu c√≥, ho·∫∑c return WAV
        console.log('M4A encoding - fallback to WAV format');
        return encodeWAV(samples, sampleRate);
    }

    // ‚îÄ‚îÄ Main convert ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function doConvert(file, targetFmt) {
        convertBtn.disabled = true;
        spinnerEl.classList.add('show');
        btnTextEl.textContent = 'ƒêang chuy·ªÉn ƒë·ªïi...';
        hideMsg();
        progressSection.classList.add('show');
        resultSection.classList.remove('show');

        var audioCtx = null;

        (async function() {
            try {
                setProgress(10, 'ƒêang ƒë·ªçc file...', 1);
                await sleep(300);

                // ƒê·ªçc file th√†nh ArrayBuffer
                var arrayBuffer = await file.arrayBuffer();

                setProgress(30, 'Kh·ªüi t·∫°o b·ªô gi·∫£i m√£ √¢m thanh...', 2);
                await sleep(200);

                var AudioCtx = window.AudioContext || window.webkitAudioContext;
                if (!AudioCtx) throw new Error('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Audio API');

                audioCtx = new AudioCtx({ sampleRate: 44100 });

                // iOS Safari t·ª± suspend context ‚Äî c·∫ßn resume tr∆∞·ªõc khi decode
                if (audioCtx.state === 'suspended') {
                    await audioCtx.resume();
                }

                setProgress(40, 'ƒêang gi·∫£i m√£ √¢m thanh... (c√≥ th·ªÉ m·∫•t v√†i gi√¢y)', 2);

                var audioBuf = await decodeAudio(audioCtx, arrayBuffer);
                var samples = audioBuf.getChannelData(0);
                var rate = audioBuf.sampleRate;

                setProgress(65, 'ƒêang m√£ ho√° ' + targetFmt.toUpperCase() + '...', 2);
                await sleep(200);

                // === ƒêI·ªÇM FIX CH√çNH: Encode theo ƒë·ªãnh d·∫°ng ƒë∆∞·ª£c ch·ªçn ===
                var outputBuffer;
                var mimeType;
                var extension;

                switch(targetFmt) {
                    case 'mp3':
                        outputBuffer = await encodeMP3(samples, rate);
                        mimeType = 'audio/mpeg';
                        extension = 'mp3';
                        break;
                    case 'ogg':
                        outputBuffer = await encodeOGG(samples, rate);
                        mimeType = 'audio/ogg';
                        extension = 'ogg';
                        break;
                    case 'm4a':
                        outputBuffer = await encodeM4A(samples, rate);
                        mimeType = 'audio/aac';
                        extension = 'm4a';
                        break;
                    default: // 'wav'
                        outputBuffer = encodeWAV(samples, rate);
                        mimeType = 'audio/wav';
                        extension = 'wav';
                }

                setProgress(88, 'ƒêang t·∫°o file k·∫øt qu·∫£...', 3);
                await sleep(150);

                var blob = new Blob([outputBuffer], { type: mimeType });
                var url  = URL.createObjectURL(blob);

                setProgress(100, 'Ho√†n th√†nh!');
                step1El.classList.add('completed');
                step2El.classList.add('completed');
                step3El.classList.remove('active');
                step3El.classList.add('completed');

                await sleep(500);

                // Hi·ªÉn th·ªã k·∫øt qu·∫£
                var base = file.name.lastIndexOf('.') > 0
                         ? file.name.substring(0, file.name.lastIndexOf('.'))
                         : file.name;
                var outName = base + '_converted.' + extension;

                resultAudio.innerHTML =
                    '<h3>File: ' + outName + '</h3>' +
                    '<audio controls playsinline webkit-playsinline>' +
                    '<source src="' + url + '" type="' + mimeType + '">' +
                    'Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ph√°t √¢m thanh.</audio><br>' +
                    '<a href="' + url + '" download="' + outName + '" class="download-btn">‚¨áÔ∏è T·∫£i v·ªÅ</a>';

                resultSection.classList.add('show');
                showMsg('‚úì Chuy·ªÉn ƒë·ªïi ' + targetFmt.toUpperCase() + ' th√†nh c√¥ng!', 'success');
                setTimeout(function() { progressSection.classList.remove('show'); }, 1500);

            } catch (err) {
                console.error('L·ªói chuy·ªÉn ƒë·ªïi:', err);
                showMsg('‚ùå ' + (err.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'), 'error');
                progressSection.classList.remove('show');
            } finally {
                if (audioCtx) { try { audioCtx.close(); } catch(e){} }
                convertBtn.disabled = false;
                spinnerEl.classList.remove('show');
                btnTextEl.textContent = 'Chuy·ªÉn ƒê·ªïi';
            }
        })();
    }

})();
</script>
</body>
</html>
